name: Pull Request
on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  verify:
    name: Verify
    uses: ./.github/workflows/verify.yml
    secrets: inherit

  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Clone repository
        uses: actions/checkout@v5
        with:
          submodules: "recursive"

      - name: Install dependencies
        uses: ./.github/actions/install-dependencies

      - name: Deploy Preview
        env:
          PREVIEW_ALIAS: ${{ env.PREVIEW_ALIAS }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          touch /tmp/deployment.txt

          bun run build
          bun x wrangler@latest versions upload >> /tmp/deployment.txt

      - name: Job Summary
        run: |
          echo "ðŸŒ† Deployed to Cloudflare Workers ðŸ¥•" >> $GITHUB_STEP_SUMMARY
          cat /tmp/deployment.txt >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        uses: actions/github-script@v8
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const NodeFS = require('node:fs')

            const deploymentLogs = NodeFS.readFileSync('/tmp/deployment.txt', 'utf8')
            const lines = deploymentLogs.split('\n')
            const start = lines.findIndex(line => line.includes('Version Preview URL: '))
            const deploymentUrl = lines.splice(start, lines.length).at(0)?.split(' ').at(-1)

            const commentMarker = '<!-- PREVIEW_DEPLOYMENT -->'

            const commentBody = `
              ${commentMarker}
              <h2>Preview Deployment ðŸŒ†</h2>
              <br />
              <a href="${deploymentUrl}" target="_blank" rel="noopener noreferrer">${deploymentUrl}</a>
            `

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            })
            const existingComment = comments.find((comment) => comment.body.includes(commentMarker))

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody,
              })
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody,
              })
            }
