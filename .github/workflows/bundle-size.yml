name: Bundle Size

on:
  push:
    branches: [main]
    # No path filter on main - we need to generate baseline on every push
    # so PRs always compare against the latest main, even if main has
    # commits that don't touch explorer (e.g., workflow changes, other apps)
  pull_request:
    types: [opened, reopened, synchronize]
    paths:
      - "apps/explorer/**"
      - "pnpm-lock.yaml"

concurrency:
  group: bundle-size-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  NODE_ENV: production

jobs:
  bundle-size:
    name: Bundle Size
    runs-on: ubuntu-latest
    permissions:
      actions: write
      pull-requests: write
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: "recursive"

      - name: Install dependencies
        uses: ./.github/actions/install-dependencies

      - name: Restore baseline from cache
        if: github.event_name == 'pull_request'
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: apps/explorer/bundle-stats.json
          key: bundle-stats-explorer-main-latest
          restore-keys: |
            bundle-stats-explorer-main-

      - name: Move baseline if exists
        if: github.event_name == 'pull_request' && steps.cache-restore.outputs.cache-hit == 'true'
        run: mv apps/explorer/bundle-stats.json apps/explorer/baseline-stats.json

      - name: Build with bundle analysis
        working-directory: apps/explorer
        env:
          ANALYZE: "true"
          ANALYZE_JSON: "true"
        run: pnpm build

      - name: Parse bundle stats (main branch)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        working-directory: apps/explorer
        run: |
          node --experimental-strip-types scripts/bundle-diff.ts \
            --skip-build \
            --output bundle-stats.json

      - name: Save bundle stats to cache (main branch)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/cache/save@v4
        with:
          path: apps/explorer/bundle-stats.json
          key: bundle-stats-explorer-main-${{ github.sha }}

      - name: Delete old latest cache (main branch)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh cache delete bundle-stats-explorer-main-latest --repo ${{ github.repository }}

      - name: Save bundle stats with stable key (main branch)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/cache/save@v4
        with:
          path: apps/explorer/bundle-stats.json
          key: bundle-stats-explorer-main-latest

      - name: Generate bundle report (PR)
        if: github.event_name == 'pull_request'
        id: bundle-report
        working-directory: apps/explorer
        run: |
          if [ -f baseline-stats.json ]; then
            REPORT=$(node --experimental-strip-types scripts/bundle-diff.ts \
              --ci \
              --skip-build \
              --baseline baseline-stats.json)
          else
            REPORT=$(node --experimental-strip-types scripts/bundle-diff.ts \
              --ci \
              --skip-build)
          fi

          # Write to file for the comment action
          echo "$REPORT" > bundle-report.md

          # Also output for debugging
          echo "$REPORT"

      - name: Find existing comment
        if: github.event_name == 'pull_request'
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "Bundle Size Report"

      - name: Post or update PR comment
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: apps/explorer/bundle-report.md
          edit-mode: replace

      - name: Upload Sonda report artifact
        uses: actions/upload-artifact@v4
        with:
          name: sonda-bundle-report-${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || format('main-{0}', github.sha) }}
          path: apps/explorer/.sonda/
          retention-days: 90

      - name: Deploy to GitHub Pages (main only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./apps/explorer/.sonda
          destination_dir: explorer-bundle-stats
          keep_files: false
