name: Test Contract Verification

on:
  workflow_dispatch:
    inputs:
      networks:
        description: "Networks to test (comma-separated: devnet,mainnet,testnet)"
        required: false
        default: "devnet,mainnet,testnet"
      verifier-url:
        description: "Verifier URL"
        required: false
        default: "https://contracts.porto.workers.dev"
  schedule:
    - cron: "0 */6 * * *"

env:
  VERIFIER_URL: ${{ github.event.inputs.verifier-url || 'https://contracts.porto.workers.dev' }}

jobs:
  tempo-check:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        network: [devnet, mainnet, testnet]
    name: tempo-check (${{ matrix.network }})
    steps:
      - name: Check if network is selected
        id: check
        run: |
          NETWORKS="${{ github.event.inputs.networks || 'devnet,mainnet,testnet' }}"
          if [[ "$NETWORKS" == *"${{ matrix.network }}"* ]]; then
            echo "skip=false" >> "$GITHUB_OUTPUT"
          else
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Install Foundry
        if: steps.check.outputs.skip != 'true'
        uses: foundry-rs/foundry-toolchain@master
        with:
          version: nightly
          network: tempo

      - name: Fetch tempo-deploy.sh
        if: steps.check.outputs.skip != 'true'
        run: |
          curl --location \
            --fail \
            --silent \
            --show-error \
            --request GET \
            --url https://raw.githubusercontent.com/tempoxyz/tempo-foundry/tempo/.github/scripts/tempo-deploy.sh \
            --output tempo-deploy.sh
          chmod +x tempo-deploy.sh

      - name: Run tempo-deploy
        if: steps.check.outputs.skip != 'true'
        env:
          ETH_RPC_URL: ${{ matrix.network == 'mainnet' && secrets.TEMPO_MAINNET_RPC_URL || matrix.network == 'testnet' && secrets.TEMPO_TESTNET_RPC_URL || secrets.TEMPO_DEVNET_RPC_URL }}
          TEMPO_FEE_TOKEN: ${{ matrix.network == 'mainnet' && '0x20c00000000000000000000016c6514b53947fdc' || '0x20c0000000000000000000000000000000000002' }}
          VERIFIER_URL: ${{ matrix.network == 'mainnet' && 'https://contracts.tempo.xyz' || env.VERIFIER_URL }}
        run: ./tempo-deploy.sh