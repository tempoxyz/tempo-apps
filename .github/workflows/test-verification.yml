name: Test Contract Verification

on:
  workflow_dispatch:
    inputs:
      networks:
        description: "Networks to test (comma-separated: testnet,moderato,devnet)"
        required: false
        default: "testnet,moderato,devnet"
      verifier-url:
        description: "Verifier URL"
        required: false
        default: "https://contracts.porto.workers.dev"
  schedule:
    - cron: "0 */6 * * *"

defaults:
  run:
    shell: bash
    working-directory: apps/contract-verification

env:
  ACTIONS_RUNNER_DEBUG: true
  VERIFIER_URL: ${{ github.event.inputs.verifier-url || 'https://contracts.porto.workers.dev' }}

jobs:
  verify-vyper:
    env:
      GH_TOKEN: ${{ github.token }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        network: [testnet, moderato, devnet]
    name: verify-vyper (${{ matrix.network }})
    steps:
      - name: Check if network is selected
        id: check
        run: |
          NETWORKS="${{ github.event.inputs.networks || 'testnet,moderato,devnet' }}"
          if [[ "$NETWORKS" == *"${{ matrix.network }}"* ]]; then
            echo "skip=false" >> "$GITHUB_OUTPUT"
          else
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v6

      - name: Install Foundry
        if: steps.check.outputs.skip != 'true'
        uses: foundry-rs/foundry-toolchain@master
        with:
          version: nightly
          network: tempo

      - name: Install uv
        if: steps.check.outputs.skip != 'true'
        uses: astral-sh/setup-uv@main
        with:
          version: latest
          python-version: "3.14"

      - name: Install vyper Compiler
        if: steps.check.outputs.skip != 'true'
        run: uv tool install vyper

      - name: Test Vyper (small counter)
        if: steps.check.outputs.skip != 'true'
        env:
          TEMPO_RPC_URL: ${{ matrix.network == 'testnet' && 'http://rpc.testnet.tempo.xyz' || matrix.network == 'moderato' && 'https://rpc.moderato.tempo.xyz' || matrix.network == 'devnet' && 'https://rpc.devnet.tempoxyz.dev' }}
          TEMPO_FEE_TOKEN: ${{ matrix.network == 'testnet' && '0x20c0000000000000000000000000000000000002' || matrix.network == 'moderato' && '0x20c0000000000000000000000000000000000002' || matrix.network == 'devnet' && '0x20c0000000000000000000000000000000000002' }}
        run: ./scripts/test-vyper.sh

  verify-solidity:
    env:
      GH_TOKEN: ${{ github.token }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        network: [testnet, moderato, devnet]
    name: verify-solidity (${{ matrix.network }})
    steps:
      - name: Check if network is selected
        id: check
        run: |
          NETWORKS="${{ github.event.inputs.networks || 'testnet,moderato,devnet' }}"
          if [[ "$NETWORKS" == *"${{ matrix.network }}"* ]]; then
            echo "skip=false" >> "$GITHUB_OUTPUT"
          else
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v6

      - name: Install Foundry
        if: steps.check.outputs.skip != 'true'
        uses: foundry-rs/foundry-toolchain@master
        with:
          version: nightly
          network: tempo

      - name: Test Solidity
        if: steps.check.outputs.skip != 'true'
        env:
          TEMPO_RPC_URL: ${{ matrix.network == 'testnet' && 'http://rpc.testnet.tempo.xyz' || matrix.network == 'moderato' && 'https://rpc.moderato.tempo.xyz' || matrix.network == 'devnet' && 'https://rpc.devnet.tempoxyz.dev' }}
          TEMPO_FEE_TOKEN: ${{ matrix.network == 'testnet' && '0x20c0000000000000000000000000000000000002' || matrix.network == 'moderato' && '0x20c0000000000000000000000000000000000002' || matrix.network == 'devnet' && '0x20c0000000000000000000000000000000000002' }}
        run: ./scripts/test-big-boy.sh
